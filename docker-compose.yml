version: "3.8"

services:
  semantic-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: semantic-service
    ports:
      - "7860:7860"

    volumes:
      # Mount index directory for persistence
      - ./backend/semantic/index:/app/index
    environment:
      - INDEX_DIR=/app/index
      - API_KEY=${API_KEY:-${SEMANTIC_SERVICE_API_KEY:-}} # Set API_KEY in .env file or environment for production
      - PYTHONUNBUFFERED=1
      # Appwrite Configuration
      - APPWRITE_ENDPOINT=${APPWRITE_ENDPOINT:-https://sgp.cloud.appwrite.io/v1}
      - APPWRITE_PROJECT_ID=${APPWRITE_PROJECT_ID:-}
      - APPWRITE_API_KEY=${APPWRITE_API_KEY:-}
      - APPWRITE_DATABASE_ID=${APPWRITE_DATABASE_ID:-}
      - APPWRITE_TABLE_ID=${APPWRITE_TABLE_ID:-}
      # S3 Configuration
      - S3_ENDPOINT=${S3_ENDPOINT:-}
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID:-}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY:-}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME:-}
      - S3_REGION=${S3_REGION:-us-east-1}
      # Service Configuration (optional, with defaults)
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-104857600}
      - PRESIGNED_UPLOAD_EXPIRES_IN=${PRESIGNED_UPLOAD_EXPIRES_IN:-900}
      - PRESIGNED_DOWNLOAD_EXPIRES_IN=${PRESIGNED_DOWNLOAD_EXPIRES_IN:-3600}
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - personal-drive-network

networks:
  personal-drive-network:
    driver: bridge
